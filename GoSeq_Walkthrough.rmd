---
title: "Working with GOSeq to do GO Term Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---



This is a step-by-step walkthrough of how to perform GO term enrichment analysis on a non-model organism using the R package goseq from Bioconductor. 

Important pre goseq steps -- you need a gene-to-GOterm map which is a list of gene identifiers and an associated GO identifier. If you produce it with my python script, GoTermsMap.py, it looks like this:

```
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0006807-nitrogen compound metabolic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0007154-cell communication(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0009058-biosynthetic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044237-cellular metabolic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044238-primary metabolic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044700-single organism signaling(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044710-single-organism metabolic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044763-single-organism cellular process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0050789-regulation of biological process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0051716-cellular response to stimulus(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0071704-organic substance metabolic process(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0043227-membrane-bounded organelle(L=2)
 ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0044421-extracellular region part(L=2)
```
 
 but will need to be edited so that it looks more like this:
 
```
ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0006807-nitrogen compound metabolic process(L=2) GO:0006807
ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0007154-cell communication(L=2)                  GO:0007154
ECEF_Abd_TRINITY_DN10037_c0_g1  GO:0009058-biosynthetic process(L=2)                GO:0009058

```
That is to say, goseq wants just the GO identifier and not the verbose category. If you are feeling clever, you can just fix it in R with regular expressions. 

You will also need a gene id to gene length map. I decided the best way to get this was to go to one of my sample's genes.results output produced from the Trinity RSEM/edgeR DE Analysis scripts. I did `cut -f 1,4` to get the gene identifier and the effective length out of a genes.results file. 

What you input to R should look like this:

```
gene_id                         length
ECEF_Abd_TRINITY_DN10007_c0_g1  1148.00
ECEF_Abd_TRINITY_DN10023_c0_g1  463.00
ECEF_Abd_TRINITY_DN10037_c0_g1  425.00
ECEF_Abd_TRINITY_DN10037_c0_g2  554.00
ECEF_Abd_TRINITY_DN10038_c0_g1  1041.00
ECEF_Abd_TRINITY_DN10044_c0_g1  1605.00
ECEF_Abd_TRINITY_DN10046_c0_g1  1211.00
ECEF_Abd_TRINITY_DN10056_c0_g1  1544.00
```

With that preliminary input information, we are ready to examine GO term enrichment with goseq!

```{r}
options(stringsAsFactors = FALSE) # this just always seems to help me. 
library("goseq")
library("dplyr")
 

```


I'm going to read in my DE analysis results...

```{r}


resdata <- read.table("EC_DESeq2_resdata.tab", header=TRUE, sep="\t")

```

Not included in this walkthrough are the creation of the DESeq object, doing the DE analysis, the creation of the resdata dataframe, and writing that dataframe to a file. We only needed to do that once, and it's time intensive to repeat. I'll just read in the data we saved earlier. Right now, I'm only using it as a way to get the length of a vector and to pick some example gene ids.


### Here are all of the steps necessary for getting GO enrichment from a list of DE features. 


1) Make a vector the same length as the number of ids. All values will be 0. 

```{r}
gene.data <- integer(length=41000)
```

2) Name the items in the vector with gene ids. 

```{r}
names(gene.data) <- 
  resdata$EC_id
```

3) Get a list of gene ids from SOMEWHERE -- here, the top 30 values for ECEF Abd in resdata

```{r}
topAbd <- arrange(resdata, ECEF_Abd) %>% top_n(30, ECEF_Abd)
topAbd_ids <- topAbd$EC_id
```

4) Use a for loop to find which element in the genes vector has the same name as one of the 
 gene ids in our list, and sets its value to 1. 

```{r}
for (item in topAbd_ids) {
  i <- which(names(gene.data)==item)
  gene.data[i] <- 1
}
```

5) Check to make sure that the number of IDs you selected equals the number that are now set to 1 in genes

```{r}
table(gene.data)
length(topAbd_ids) == table(gene.data)[2]
```

6) Then omit NAs (probably skippable because of how we created the vector, but could be a problem for other means.)

```{r}
genes.list <- na.omit(gene.data)
```

7) Get the feature length data and the category mapping data. Filter with dplyr to just be for the genes in our genes list.

```{r}
feature.lengths <- read.table("../GOAnalysis/ECEF_Genes_Lengths.txt", header=TRUE, sep="\t")
cat.map <- read.table("../GOAnalysis/ECEF_GoTerm_Extended.txt", header=FALSE, sep="\t")
GoCats <- cat.map[,c(1,3)]

genes.length.data <- filter(feature.lengths, gene_id %in% names(genes.list))
```

8) Make the length data into a vector with names.

```{r}
genes.bias.data <- genes.length.data$length
names(genes.bias.data) <- genes.length.data$gene_id
```

9) Fit the probability weighting function and then plot it. 

```{r}
pwf <- nullp(genes.list, bias.data = genes.bias.data, plot.fit = FALSE)
plotPWF(pwf = pwf, binsize=200) # <-- you can change the binsize if you like, bins of 200 genes seems good to me. 
```

10) Perform the Wallenius test (use the goseq function) to get the most enriched go cats

```{r}
GO.wall <- goseq(pwf, gene2cat = GoCats, method = "Wallenius")
```

Done. Save the data to a tab file to use for making graphics outputs. 

```{r}
write.table(GO.wall, "EC-top30Abd_GoSeq_Wallenius.tab", sep="\t")

```

### And let's take a look at the top twenty, shall we? 

```{r}
sorted.GO <- arrange(GO.wall, GO.wall$over_represented_pvalue) %>% 
  slice(1:20)

sorted.GO

#What are the top 20 over represented GOTerms?
sorted.GO[,c(1,6)]

```

Note -- for some reason, many of the GOterms that EnTAP assigned are deprecated, or maybe just not meant to be used the way we're using them, and so they show up as NAs. Those GOTerms can be searched on the Amigo browser and you can find a redirect to the current ontology version. For example, GO:0043234 was replaced by GO:0032991, protein-containing complex, a cellular component term. 


That's all! The hard part is deciding *which* set of genes to examine. 


